app-id: com.rustdesk.rustdesk
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: rustdesk

sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.llvm14

finish-args:
  - --device=dri
  - --filesystem=host
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=x11

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/llvm14/bin
  prepend-ld-library-path: /usr/lib/sdk/llvm14/lib
  build-args:
    - --share=network
  env: 
    - CARGO_HOME: "/run/build/rust-flatpak/cargo"
    - CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: "clang"
    - CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: "-C link-arg=-fuse-ld=/usr/lib/sdk/rust-stable/bin/mold"
    - CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: "clang"
    - CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUSTFLAGS: "-C link-arg=-fuse-ld=/usr/lib/sdk/rust-stable/bin/mold"

modules:
  - name: xdo
    buildsystem: simple
    build-commands:
      - make PREFIX=/app install
    sources:
      - type: git
        url: https://github.com/jordansissel/xdotool.git

  - name: xtst
    sources:
      - type: git
        url: https://github.com/freedesktop/xorg-libXtst.git
  
  - name: xinerama
    sources:
      - type: git
        url: https://github.com/freedesktop/libXinerama.git
  
  - name: xdmcp
    sources:
      - type: git
        url: https://github.com/freedesktop/libXdmcp.git
        
  - name: xext
    sources: 
      - type: git
        url: https://github.com/freedesktop/libXext.git
        
  - name: pynput
    buildsystem: simple
    build-commands:
      - flatpak-pip-generator pynput
  
  - name: rustdesk
    buildsystem: simple
    build-commands:
      - sh vcpkg/bootstrap-vcpkg.sh
      - vcpkg/vcpkg install libvpx libyuv opus
      - mkdir -p /app/lib/rustdesk/
      - wget https://github.com/c-smile/sciter-sdk/raw/29a598b6d20220b93848b5e8abab704619296857/bin.lnx/x64/libsciter-gtk.so 
      - mkdir -p /app/lib/rustdesk
      - mkdir -p target/debug
      - cp -r libsciter-gtk.so target/debug
      - cp -r libsciter-gtk.so /app/lib/rustdesk
      - python3 inline-sciter.py 
      - VCPKG_ROOT=${PWD}/vcpkg cargo build --features inline,appimage --release
      # - popd
      - install -D -m 755 target/release/rustdesk /app/bin/rustdesk
    sources:
      - type: git
        url: https://github.com/rustdesk/rustdesk.git
      - type: git
        url: https://github.com/microsoft/vcpkg.git
        # tag: 2021.12.01
        dest: vcpkg
